<html>
<head>
<title>crx2app Barrier Proxy Test Page Wrapper</title>
<style>
iframe {
  padding: 50px;
  width: 80%;
}
</style>
<script>

/*global console window */

function detach() {
  console.log("Test page detach on unload");
}

function PluginController(name) {
  this.name = name;
  this.url = name +".html";
  window.addEventListener('message', this.onMessage.bind(this), false);
}

PluginController.prototype = {
  // simulate loading plugin
  //
  load: function() {
    var iframe = document.createElement('iframe');
    iframe.addEventListener('unload', detach, false);
    iframe.setAttribute('src', this.url);
    var elt = document.getElementById('loadPluginsHere');
    elt.appendChild(iframe);
    this.plugin = iframe;
    return iframe;
  },
  onMessage: function(event) {
    console.log("onMessage "+event.source.location+": "+event.data);
    if (event.data === this.name) {
      console.log("Test page got "+event.data);
      var elt = document.getElementById(this.name);
      // listen for user clicks
      elt.addEventListener('click', this.test.bind(this), false);
      // release the button
      elt.removeAttribute('disabled');
    }
  },
  test: function() {
    this.plugin.contentWindow.postMessage("go", "*");
  }
};

function attach(event) {
  window.openWindowPlugin = new PluginController('openWindowTest');
  window.openWindowPlugin.load();
  window.DemoDebuggerPlugin = new PluginController('DemoDebugger');
  window.DemoDebuggerPlugin.load();
}


function onLoad() {
  // clean up
  window.removeEventListener('load', onLoad, false);
  
  attach();
}

// as soon as we load, setup the test
//
window.addEventListener('load', onLoad, false);

</script>
</head>
<body>
<h1>Test page for crx2app.</h1>
<p> Loads iframe 'plugins' that use chromeIFrame to connect to chrome extension system.</p>
<button id='openWindowTest' disabled >Push To Test Open Window</button>
<button id='DemoDebugger' disabled >Push To Test Debugger</button>
<dl id='result'>
</dl>
<div id="loadPluginsHere">
</div>
</body>
</html>