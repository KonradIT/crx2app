<html>
<head>
<title>crx2app Barrier Proxy Test Page Wrapper</title>
<style>
iframe {
  padding: 50px;
  width: 80%;
}
</style>
<script>

/*global console window */

function detach() {
  console.log("Test page detach on unload");
}

// simulate loading plugin
//
function loadPlugin(url) {
  var iframe = document.createElement('iframe');
  iframe.addEventListener('unload', detach, false);
  iframe.setAttribute('src', url);
  var elt = document.getElementById('loadPluginsHere');
  elt.appendChild(iframe);
  return iframe;
}

function attach(event) {
  window.openWindowPlugin = loadPlugin("openWindowTest.html");
  window.jsDebuggerPlugin = loadPlugin("jsDebugger.html");
}

// Fire the test code.
//
function testConnection() {
  window.openWindowPlugin.contentWindow.postMessage("go", "*");
}

function onMessage(event) {
  console.log("Test page got "+event.data);

  var test = document.getElementById('test');
  // listen for user clicks
  test.addEventListener('click', testConnection, false);
  // release the button
  test.removeAttribute('disabled');
}

function onLoad() {
  // clean up
  window.removeEventListener('load', onLoad, false);
  
  // listen for our plugin to be ready
  window.addEventListener('message', onMessage, false);
  
  // add the plugin
  attach();
}

// as soon as we load, setup the test
//
window.addEventListener('load', onLoad, false);

</script>
</head>
<body>
<h1>appEnd test</h1>
<button id='test' disabled >Push To Test</button>
<dl id='result'>
</dl>
<div id="loadPluginsHere">
</div>
</body>
</html>