<html>
<head>
<title>crx2app: Orion plugin tester</title>
<script src="../appEnd/proxyChromePipe.js"></script>
<script src="../lib/q/q.js"></script>
<script src="../lib/requirejs/require.js"></script>
<script>
/*global getChromeExtensionPipe window console Q require */

// We are a plugin in Orion, we have an internal chromeIframe talking to chrome.

var iframeDomain ="chrome-extension://bbjpappmojnmallpnfgfkjmjnhhplgog";

var connection = getChromeExtensionPipe(iframeDomain);


// dynamic iframe load
//
function loadPlugin(url) {
  var iframe = document.createElement('iframe');
  iframe.setAttribute('src', url);
  var elt = document.getElementById('loadChromeIframe');
  elt.appendChild(iframe);
}

function attach(event) {
  // listen for a connection.
  connection.attach(function() {
    
    // connected to chrome
    
    // we have connected to the extension, plugin to Orion
    window.parent.postMessage("Ready for Orion", "*");
    
    console.log("Plugin Ready ");
  });
  
  // dynamically load the chromeIframe, it will connect and fire the callback
  // (if we load the iframe statically, 
  // this outer load event will come *after* the iframe load event.)
  loadPlugin(iframeDomain + "/appEnd/chromeIframe.html");
}

function detach() {
  connection.detach();
}

// Fire the test code.
//
function testConnection(connection) {
    var win = connection.debuggr.promiseWindow();
    Q.when(win, function resolved(win) {
      console.log("Window as promised ", win);
    }, function rejected(msgObj) {
      console.error("Debugger.promiseResponse invalid message", msgObj);
    });
}

function onMessage(event) {
  if (event.data === 'go') {
    // dynamically load the debugger code
    require({
      paths: {
        "browser/remote": "remote",
        "lib/q":          "../lib/q"
      }
    }); 

   require.onError = function(err) {
     console.error(err+"", {stack: err.stack.split('\n')});
   };

   require(['jsDebugger'], function testIt(jsDebugger) {
      jsDebugger.connect(connection);
      testConnection(connection);
    });
  }
}

function onLoad() {
  // clean up
  window.removeEventListener('load', onLoad, false);
  
  // listen for fake-Orion to tell us to do something
  window.addEventListener('message', onMessage, false);
  
  // connect to the chromeIframe
  attach();
};

// as soon as we load, setup the test
//
window.addEventListener('load', onLoad, false);

</script>
</head>
<body>
<h1>Orion plugin test iframe</h1>
<div id="loadChromeIframe">
</div>
</body>
</html>